version: 2.1
jobs:
  Run-Test:
    machine:
      image: ubuntu-2004:202010-01
      docker_layer_caching: true
    steps:
      - checkout
      - run:
          name: Build Docker Image
          command: docker build -t dockerifont21/react-test -f ./client/Dockerfile.dev ./client
      - run:
          name: Test App
          command: docker run -e CI=true dockerifont21/react-test npm test
  Deploy:
    machine:
      image: ubuntu-2004:202010-01
    steps:
      - checkout
      - run:
          name: Setting up GCloud
          command: |
            echo $KEY
            openssl aes-256-cbc -d -in service-account.enc -out service-account.json -k $KEY
            ls -la
workflows:
  Pipeline:
    jobs:
      - Run-Test
      - Deploy